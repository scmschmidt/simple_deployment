#!/bin/bash

set -e
LANG=C

# Include shared functions.
. "${0%*${0##*/}}include"

# Update snapshot variables (including status).
update_ss_vars

# Check if we are already in the recovery snapshot.
[ "${ss_recovery}" == "${ss_active}" ] && { log "Recovery snapshot (${ss_recovery}) is already active." ; exit 0 ; }

# Set recovery snapshot as default:
subvol=$(btrfs subvolume list -t / | expand | grep " @/.snapshots/${ss_recovery}/snapshot$" | tr -s ' ' | cut -d ' ' -f1)
[ -z "${subvol}" ] && exit_on_error "Something went wrong. No subvolume not found for snapshot ${ss_recovery}."
btrfs subvolume set-default ${subvol} /
log "Recovery snapshot (${ss_recovery}) set as default (subvol=${subvol})."
log "Status: recovery_set"
echo 'recovery_set' > "${status_file}"

# Bye.
exit 0
